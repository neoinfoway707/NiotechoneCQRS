@using NiotechoneCQRS.Application.DTOs.ResponseDTOs
@using UserRes = NiotechoneCQRS.Utility.User.User
@using CommonRes = NiotechoneCQRS.Utility.CommonResource.AppResource
@{
    ViewBag.PageTitle = UserRes.UserList;
    ViewBag.ShowBackButton = true;
    ViewBag.Breadcrumb = $"<i class='fa fa-folder'></i> {UserRes.UserList}";
}
@model UserListModelDTO

@{
    ViewData["Title"] = UserRes.UserList;
}
<link href="~/css/user.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Inter:wght@400;500;600&family=Wix+Madefor+Display:wght@400&display=swap" rel="stylesheet">


<!-- Tabs Navigation with exact master design -->
<div class="tabs">
    <a class="tab active" data-tab="user" href="/User/Index">@ViewData["Title"]</a>
    <div class="tab" data-tab="work-request">Work Request</div>
    <div class="tab" data-tab="pre-inspection">Pre-Inspection</div>
    <div class="tab" data-tab="work-order">Work Order</div>
    <div class="tab" data-tab="invoicing">Invoicing</div>
</div>

<!-- User Tab Content -->
<div id="user-content" class="tab-content-container">
    <div class="table-container">
        <!-- Table Header with Add Button -->
        <div class="table-header">
            <button class="customize-button">
                <svg viewBox="0 0 20 20">
                    <path d="M7.33333 7.33333V3.33333H8.66667V7.33333H12.6667V8.66667H8.66667V12.6667H7.33333V8.66667H3.33333V7.33333H7.33333Z" fill="white" />
                </svg>
                @CommonRes.CustomizeColumns
            </button>
        </div>

        <!-- Data Table -->
        <table class="data-table">
            <thead>
                <tr>
                    <th>
                        <span> @UserRes.FullName</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.UserName</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.Email</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.Status</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.UserRole</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.Address</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.Phone</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.LastLogin</span>
                        <svg class="filter-icon" viewBox="0 0 16 16">
                            <path d="M6.66667 12H9.33333V10.6667H6.66667V12ZM2 4V5.33333H14V4H2ZM4 8.66667H12V7.33333H4V8.66667Z" fill="#64748B" />
                        </svg>
                    </th>
                    <th>
                        <span>@UserRes.Actions</span>
                    </th>
                </tr>
            </thead>
            <tbody id="tableBody">
                @{
                    int totalCount = Model.data != null ? Model.data.Count() : 0;
                }

                @if (Model.data != null && Model.data.Any())
                {
                    @foreach (var emp in Model.data)
                    {
                        <tr class="data-row">
                            <td>
                                <a href="/User/Edit/@emp.userId" class="user-link">@emp.fullName</a>
                            </td>
                            <td>@emp.userName</td>
                            <td>@emp.email</td>
                            <td>
                                @{
                                    string statusClass = "pending";
                                    string statusText = "Pending";

                                    if (emp.statusId == 1)
                                    {
                                        statusClass = "active";
                                        statusText = "Active";
                                    }
                                    else if (emp.statusId == 0)
                                    {
                                        statusClass = "inactive";
                                        statusText = "Inactive";
                                    }
                                }
                                <span class="status @statusClass">
                                    @statusText
                                </span>
                            </td>
                            <td>@emp.userRoleId</td>
                            <td>@emp.address</td>
                            <td>@emp.phone</td>
                            <td>
                                @{
                                    string lastLogin = "";
                                    if (emp.lastLoginDate != null)
                                    {
                                        try
                                        {
                                            lastLogin = ((DateTime)emp.lastLoginDate).ToString("MMM dd, yyyy");
                                        }
                                        catch
                                        {
                                            lastLogin = emp.lastLoginDate.ToString();
                                        }
                                    }
                                }
                                @lastLogin
                            </td>
                            <td>
                                <div style="display: flex; gap: 4px;">
                                    @* <a href="/User/Edit/@emp.userId" class="action-btn btn-edit" id="editListButton" title="Edit"> *@
                                    <a href="/User/Edit/@emp.userId?mode=edit"
                                       class="action-btn btn-edit"
                                       title="Edit">

                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <form method="post" action="/User/Delete/@emp.userId" onsubmit="return confirm('Are you sure you want to delete this user?');" style="display:inline;">
                                        <button type="submit" class="action-btn btn-delete" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #64748B;">
                            No users found
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Table Footer with Pagination -->
        <div class="table-footer">
            <div class="footer-left">
            <div class="pagination-info">
                <span>@CommonRes.Showing <span id="startRow">1</span> - <span id="endRow">10</span> @CommonRes.of <span id="totalRows">@totalCount</span></span>
                <select class="page-size-select" id="pageSizeSelect">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>            

            <div class="pagination-controls">
                <button class="pagination-btn" id="firstPage" onclick="goToFirstPage()">
                    <svg viewBox="0 0 16 16">
                        <path d="M6.72387 8L3.52861 11.1953L4.47141 12.1381L8.60947 8L4.47141 3.86194L3.52861 4.80475L6.72387 8ZM11.3333 4.00001V12H10V4.00001H11.3333Z" fill="currentColor" transform="rotate(180 8 8)" />
                    </svg>
                </button>
                <button class="pagination-btn" id="prevPage" onclick="goToPrevPage()">
                    <svg viewBox="0 0 16 16">
                        <path d="M8.7813 8.00047L5.48145 4.70062L6.42426 3.75781L10.6669 8.00047L6.42426 12.2431L5.48145 11.3003L8.7813 8.00047Z" fill="currentColor" transform="rotate(180 8 8)" />
                    </svg>
                </button>
                <span class="page-number-text" style="padding: 8px 12px; color: #64748B; display: none;">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                <button class="pagination-btn" id="nextPage" onclick="goToNextPage()">
                    <svg viewBox="0 0 16 16">
                        <path d="M8.7813 8.00047L5.48145 4.70062L6.42426 3.75781L10.6669 8.00047L6.42426 12.2431L5.48145 11.3003L8.7813 8.00047Z" fill="currentColor" />
                    </svg>
                </button>
                <button class="pagination-btn" id="lastPage" onclick="goToLastPage()">
                    <svg viewBox="0 0 16 16">
                        <path d="M6.72387 8L3.52861 11.1953L4.47141 12.1381L8.60947 8L4.47141 3.86194L3.52861 4.80475L6.72387 8ZM11.3333 4.00001V12H10V4.00001H11.3333Z" fill="currentColor" />
                    </svg>
                </button>
            </div>
            </div>

            <div class="table-actions">
                <button class="export-btn">
                    <svg viewBox="0 0 16 16">
                        <path d="M2.66667 12.6667H13.3333V8H14.6667V13.3333C14.6667 13.7015 14.3682 14 14 14H2C1.63181 14 1.33333 13.7015 1.33333 13.3333V8H2.66667V12.6667ZM8.66667 6V10.6667H7.33333V6H4L8 2L12 6H8.66667Z" fill="currentColor" />
                    </svg>
                    @CommonRes.Export
                </button>

                <a href="@Url.Action("Create", "User")" class="add-btn">
                    <svg viewBox="0 0 20 20" fill="white" width="16" height="16">
                        <path d="M10.8333 9.16667V3.33333H9.16667V9.16667H3.33333V10.8333H9.16667V16.6667H10.8333V10.8333H16.6667V9.16667H10.8333Z" />
                    </svg>
                    @CommonRes.Add
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Placeholder content for other tabs -->
<div id="work-request-content" class="tab-content-container hidden">
    <div class="table-container">
        <div class="tab-content">
            <div>
                <h3>Work Request Management</h3>
                <p>Work request content will be displayed here.</p>
                <p>This would include work request forms, tracking, and management.</p>
            </div>
        </div>
    </div>
</div>

<div id="pre-inspection-content" class="tab-content-container hidden">
    <div class="table-container">
        <div class="tab-content">
            <div>
                <h3>Pre-Inspection Management</h3>
                <p>Pre-inspection forms and checklists will be displayed here.</p>
                <p>This section manages pre-inspection processes.</p>
            </div>
        </div>
    </div>
</div>

<div id="work-order-content" class="tab-content-container hidden">
    <div class="table-container">
        <div class="tab-content">
            <div>
                <h3>Work Order Management</h3>
                <p>Work order management content will be displayed here.</p>
                <p>This section handles work order creation, assignment, and tracking.</p>
            </div>
        </div>
    </div>
</div>

<div id="invoicing-content" class="tab-content-container hidden">
    <div class="table-container">
        <div class="tab-content">
            <div>
                <h3>Invoicing Management</h3>
                <p>Invoicing and billing content will be displayed here.</p>
                <p>This section manages invoices, payments, and billing records.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize pagination FIRST
        initializePagination();

        // Then set up tabs
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.table-container');

        // Add click event listeners to tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');

                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));

                // Add active class to clicked tab
                this.classList.add('active');

                // Hide all tab contents
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });

                // Show selected tab content
                const activeContent = document.getElementById(`${tabName}-content`);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
            });
        });


         let currentSort = {
        column: null,
        direction: 'asc'
    };
    
    // Add click event to sortable headers
    document.querySelectorAll('.data-table th.sortable').forEach(th => {
        th.addEventListener('click', function() {
            const columnIndex = Array.from(this.parentNode.children).indexOf(this);
            const dataKey = this.dataset.sort;
            
            // Toggle sort direction
            if (currentSort.column === columnIndex) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = columnIndex;
                currentSort.direction = 'asc';
            }
            
            // Sort the table
            sortTable(columnIndex, currentSort.direction, dataKey);
            
            // Update sort indicators
            updateSortIndicators(columnIndex, currentSort.direction);
        });
    });
    
    function sortTable(columnIndex, direction, dataKey) {
        const table = document.querySelector('#usersTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Remove "no data" row if present
        const noDataRow = rows.find(row => row.cells.length === 1);
        if (noDataRow) {
            noDataRow.remove();
        }
        
        rows.sort((a, b) => {
            const cellA = a.cells[columnIndex];
            const cellB = b.cells[columnIndex];
            
            let valueA, valueB;
            
            // Get sortable value based on data-key
            if (dataKey === 'status') {
                valueA = parseInt(cellA.querySelector('.status').dataset.sort) || 0;
                valueB = parseInt(cellB.querySelector('.status').dataset.sort) || 0;
            } else if (dataKey === 'lastLogin') {
                const dateA = cellA.dataset.sortValue || '';
                const dateB = cellB.dataset.sortValue || '';
                valueA = dateA ? new Date(dateA).getTime() : 0;
                valueB = dateB ? new Date(dateB).getTime() : 0;
            } else {
                valueA = cellA.textContent.trim().toLowerCase();
                valueB = cellB.textContent.trim().toLowerCase();
                
                // Try numeric comparison
                const numA = parseFloat(valueA);
                const numB = parseFloat(valueB);
                if (!isNaN(numA) && !isNaN(numB)) {
                    valueA = numA;
                    valueB = numB;
                }
            }
            
            if (valueA < valueB) return direction === 'asc' ? -1 : 1;
            if (valueA > valueB) return direction === 'asc' ? 1 : -1;
            return 0;
        });
        
        // Re-add rows in sorted order
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function updateSortIndicators(columnIndex, direction) {
        // Remove all sort classes
        document.querySelectorAll('.data-table th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Add class to current sort column
        const currentTh = document.querySelector(`.data-table th:nth-child(${columnIndex + 1})`);
        if (currentTh) {
            currentTh.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    }
    });

    // Pagination Variables
    let currentPage = 1;
    let rowsPerPage = 10;
    let allRows = [];

    function initializePagination() {
        console.log('Initializing pagination...');

        // Get all data rows
        allRows = Array.from(document.querySelectorAll('#tableBody tr.data-row'));
        console.log('Found data rows:', allRows.length);

        // Get the no data row if it exists
        const noDataRow = document.querySelector('#tableBody tr:not(.data-row)');

        // Set initial rows per page from select
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        if (pageSizeSelect) {
            rowsPerPage = parseInt(pageSizeSelect.value);
        }

        // If no data rows exist
        if (allRows.length === 0) {
            console.log('No data rows found');
            if (noDataRow) {
                noDataRow.classList.add('visible-row');
            }
            updatePaginationInfo();
            updatePaginationControls();
            return;
        }

        console.log('Total rows:', allRows.length, 'Rows per page:', rowsPerPage);

        // Show first page
        showPage(1);
        updatePaginationInfo();
        updatePaginationControls();
    }

    function showPage(page) {
        console.log('Showing page:', page);
        const startIndex = (page - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;

        // Remove visible class from all rows
        allRows.forEach(row => {
            row.classList.remove('visible-row');
        });

        // Show rows for current page
        const rowsToShow = allRows.slice(startIndex, endIndex);
        rowsToShow.forEach(row => {
            row.classList.add('visible-row');
        });

        console.log('Showing rows:', startIndex + 1, 'to', Math.min(endIndex, allRows.length));
    }

    function updatePaginationInfo() {
        const totalRows = allRows.length;
        const startIndex = (currentPage - 1) * rowsPerPage + 1;
        const endIndex = Math.min(currentPage * rowsPerPage, totalRows);
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        if (document.getElementById('startRow')) {
            document.getElementById('startRow').textContent = totalRows > 0 ? startIndex : 0;
        }
        if (document.getElementById('endRow')) {
            document.getElementById('endRow').textContent = totalRows > 0 ? endIndex : 0;
        }
        if (document.getElementById('totalRows')) {
            document.getElementById('totalRows').textContent = totalRows;
        }
        if (document.getElementById('currentPage')) {
            document.getElementById('currentPage').textContent = currentPage;
        }
        if (document.getElementById('totalPages')) {
            document.getElementById('totalPages').textContent = totalPages || 1;
        }
    }

    function updatePaginationControls() {
        const totalRows = allRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        const firstPageBtn = document.getElementById('firstPage');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const lastPageBtn = document.getElementById('lastPage');

        if (firstPageBtn) {
            firstPageBtn.disabled = currentPage === 1 || totalRows === 0;
        }
        if (prevPageBtn) {
            prevPageBtn.disabled = currentPage === 1 || totalRows === 0;
        }
        if (nextPageBtn) {
            nextPageBtn.disabled = currentPage === totalPages || totalRows === 0;
        }
        if (lastPageBtn) {
            lastPageBtn.disabled = currentPage === totalPages || totalRows === 0;
        }
    }

    // Pagination functions
    function goToFirstPage() {
        if (currentPage !== 1 && allRows.length > 0) {
            currentPage = 1;
            showPage(currentPage);
            updatePaginationInfo();
            updatePaginationControls();
        }
    }

    function goToPrevPage() {
        if (currentPage > 1 && allRows.length > 0) {
            currentPage--;
            showPage(currentPage);
            updatePaginationInfo();
            updatePaginationControls();
        }
    }

    function goToNextPage() {
        const totalPages = Math.ceil(allRows.length / rowsPerPage);
        if (currentPage < totalPages && allRows.length > 0) {
            currentPage++;
            showPage(currentPage);
            updatePaginationInfo();
            updatePaginationControls();
        }
    }

    function goToLastPage() {
        const totalPages = Math.ceil(allRows.length / rowsPerPage);
        if (currentPage !== totalPages && allRows.length > 0) {
            currentPage = totalPages;
            showPage(currentPage);
            updatePaginationInfo();
            updatePaginationControls();
        }
    }

    // Handle page size change
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', function() {
            rowsPerPage = parseInt(this.value);
            currentPage = 1;
            showPage(currentPage);
            updatePaginationInfo();
            updatePaginationControls();
        });
    }

    // Export functionality
    const exportBtn = document.querySelector('.export-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            alert('Export functionality would be implemented here');
        });
    }

</script>