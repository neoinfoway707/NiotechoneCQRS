@using Kendo.Mvc.UI
@using NiotechoneCQRS.Application.DTOs.ResponseDTOs

@model IEnumerable<UserModel>

<div id="parentHorizontalTab">
    <div class="clearfix"></div>
    <div class="tab-content col mt-3">
        <div>
            <div class="clearfix"></div>
            <div class="row">
                <div class="col-lg-5 col-md-12 pull-left">
                    <div class="form-group row">
                        @if (ViewBag.IsTenant == false)
                        {
                            <div class="col-sm-8">
                                @Html.DropDownList("TenantList", (IEnumerable<SelectListItem>)ViewBag.TenantList, new { @class = "form-control", @id = "tenantDdl" })
                                @Html.Hidden("companyId")
                            </div>
                        }
                        else
                        {
                            <div class="col-sm-8">
                                <input type="text" class="form-control" readonly="true" value="@ViewBag.TenantName" />
                                @Html.Hidden("companyId")
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
            <div class="tab-pane fade show active" id="userlist" role="tabpanel" aria-labelledby="userlist-tab">
                @* <div>
                    @(Html.Kendo().Grid(Model)
                                        .Name("UserListGrid")
                                        .Columns(columns =>
                                        {
                                            columns.Bound(p => p.UserId).Visible(false);
                                            columns.Bound(p => p.PersonalTypeId).Visible(false);
                                            columns.Bound(p => p.FullName).Title(WorkOrderResource.FullName).Width("40%").ClientTemplate("#if((('" + (bool)ViewBag.IsCompanySwitchingEnabled + "'=='True') && (PersonalTypeId == null || PersonalTypeId == " + (int)Enums.PersonnelType.InHouse + ")) || (UserRoleName != 'crew' && UserRoleName != 'crew-admin')){#" + "<a class='inline-link' href='" + Url.Action("UserDetail", "SGEAdmin") + "?userIdp=#= UserIdEncrypt#&allowEdit=false&statusFlag" + Uri.EscapeDataString(SGE.Aladdin.Common.Encryption.CryptorHelper.Encrypt(Convert.ToString(true), true)) + "'" + ">#= FullName# </a>" + "#}else {#<a>#= FullName# </a>#} #");
                                            columns.Bound(p => p.UserName).Title(AdminResources.Username).Width("40%");
                                            columns.Bound(p => p.Email).Title(AdminResources.Emailaddress).Width("40%");
                                            columns.Bound(p => p.StatusName).Title(AdminResources.Status).Width("20%");
                                            columns.Bound(p => p.UserRoleName).Title(AdminResources.Userrole).Width("40%");
                                            columns.Bound(p => p.Address).Title(AdminResources.Address).Width("30%");
                                            columns.Bound(p => p.Phone).Title(AdminResources.Phone).Width("30%");
                                            columns.Bound(p => p.LastLoginDate).Title(AdminResources.LastLoginDate).Width("40%");
                                            columns.Template(@<text></text>).ClientTemplate("<a href='" + Url.Action("UserDetail", "SGEAdmin") + "?userIdp=#= UserIdEncrypt#&allowEdit=true&statusFlag"
                                            + Uri.EscapeDataString(SGE.Aladdin.Common.Encryption.CryptorHelper.Encrypt(Convert.ToString(true), true)) + "'"
                                            + "class='edit-ico'" + "title='" + string.Format(CommonResources.EditTooltip, TenantResource.Tenant) + "'>" + "</a>"
                                            ).Title(CommonResources.Edit).Width("10%");

                                            if (ViewBag.IsTenant == false)
                                            {
                                                columns.Template(@<text></text>).ClientTemplate("#if(UserRoleName != 'crew' && UserRoleName != 'crew-admin'){#" + "<a href='javascript:void(0);' onclick='DeleteUser(#:UserId#);' class='delete-ico' title='" + string.Format(CommonResources.DeleteTooltip, AdminResources.Tenant) + "'>" + "</a>" + "#}else {# #} #").Title(CommonResources.Delete).Width("10%");
                                            }
                                        })
                                        .Events(events => events.DataBinding("onDataBinding"))
                                        .DataSource(dataSource => dataSource
                                        .Ajax()
                                        .Model(model => model.Id(p => p.UserId))
                                        .Read(read => read.Action("GetUserList", "SGEAdmin").Data("additionalInfo"))
                                        .PageSize(int.Parse(ConfigurationManager.AppSettings[Constant.DEFAULTGRIDPAGESIZE]))
                                        )
                                        .Pageable(p => p.PageSizes(new[] { 5, 10, 20, 50, 100 }))
                                        .Reorderable(x => x.Columns(true))
                                        .Resizable(x => x.Columns(true))
                                        .Scrollable()
                                        .Sortable(x => x.Enabled(true))
                                        )
                </div> *@
            </div>
        </div>
    </div>
</div>

<script>
    function onDataBinding(arg) {
        if ($("#UserListGrid").data("kendoGrid").dataSource.data().length > 0) {
            $("#btnExcelUser").show();
            $("#btnPdfUser").show();
        } else {
            $("#UserListGrid").find('.k-grid-content').css("overflow-y", "hidden");
            $("#UserListGrid").find('.k-grid-content').css("overflow-x", "hidden");
            $("#btnExcelUser").hide();
            $("#btnPdfUser").hide();
        }
    }
    var companyId = '@ViewBag.Tenant';
    $(document).ready(function () {
        $("#tenantDdl").val('@ViewBag.Tenant');
        $("li.active").removeClass("active");
        $("#UserList").addClass("active");
        $("#AddUser").click(function () {
            location.href = '@Url.Action("UserDetail", "SGEAdmin")'+'?allowEdit=true';
        });

        $("#btnExcelUser").click(function () {
            window.location.href = '@Url.Action("ExportToExcelForUserList", "SGEAdmin")';
        });

        $("#btnPdfUser").click(function () {
            window.location.href = '@Url.Action("ExportToPdfForUserList", "SGEAdmin")';
        });

        $("#tenantDdl").change(function () {
            companyId = $("#tenantDdl").val();
            var ds = $("#UserListGrid").data("kendoGrid").dataSource;
            ds.read();
        });
    });
    function additionalInfo() {
        return {
            companyId: companyId
        }
    }
    function DeleteUser(userId) {
        $('#deleteUserConfirmationModal').modal('show');
        $('#deleteUserConfirmationModal').find('.modal-body #deleteConfirmOk').on('click', function () {
            $.ajax({
                url: '@Url.Action("DeleteUser", "SGEAdmin")',
                type: 'POST',
                data: { userId: userId },
                success: function (result) {
                    $('#deleteUserConfirmationModal').modal('hide');
                    $('#deleteUserConfirmModal').modal('show');
                    $('#deleteUserMessage').html(result.message);

                    var ds = $("#UserListGrid").data("kendoGrid").dataSource;
                    ds.read();
                }
            });
        });
    }
    
</script>
<div class="modal fade" id="deleteUserConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog deleteModalPopup">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Delete</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <h4>DeleteConfirmMessage</h4>
                <button class="btn" id="deleteConfirmOk">Ok</button>
                <button class="btn " data-dismiss="modal" id="deleteConfirmCancel">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteUserConfirmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog deleteModalPopup">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Delete</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <h4 id="deleteUserMessage"></h4>
                <button class="btn" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>
